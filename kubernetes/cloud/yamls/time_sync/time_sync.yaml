apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ntp-configurator
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: ntp-configurator
  template:
    metadata:
      labels:
        name: ntp-configurator
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: config-ntp
        image: alpine
        securityContext:
          privileged: true
        command: ["/bin/sh", "-c"]
        args:
          - |
            nsenter -t 1 -m -u -n -i -- sh -c "
              # 1. Stop the default Ubuntu sync service
              systemctl stop systemd-timesyncd
              systemctl mask systemd-timesyncd

              # 2. Install Chrony if it's missing
              if ! command -v chronyd > /dev/null 2>&1; then
                apt-get update && apt-get install -y chrony
              fi

              # 3. Create the config file safely using printf
              # This avoids the heredoc 'EOF' issue in nested shells
              printf 'pool br.pool.ntp.org iburst\nserver 1.1.1.1 iburst\nserver 8.8.8.8 iburst\nmakestep 0.1 3\nrtcsync\n' > /etc/chrony/chrony.conf

              # 4. Open local firewall port (UFW) just in case
              if command -v ufw > /dev/null 2>&1; then
                ufw allow out 123/udp
              fi

              # 5. Restart and force sync
              systemctl restart chrony
              chronyc makestep
              sleep 5
              chronyc tracking
            "
            sleep infinity